import{_ as L,u as U,r as d,c as R,o as W,a as y,b as C,d as s,n as K,e as H,f as E,t as T,p as q,g as A,i as b,h as X,j as G,k as P,E as i,l as Q,m as Y,q as Z,F as ee,s as te,w as se,v as ae,x as oe,y as ne,z as ce,A as N,B as D}from"./index-5413ef58.js";const le=o=>(q("data-v-cf2debcc"),o=o(),A(),o),re={class:"main"},ie={class:"metainfo"},de={class:"username"},ue=le(()=>s("div",{class:"decoration"},null,-1)),me={class:"content"},ge={class:"chat-message"},pe={class:"time-stamp"},he={class:"TimeLine"},ve={__name:"chatMessage",props:{avatarSelected:Number},emits:["messageHeight"],setup(o,{emit:p}){const $=o;U();const m=d(new Date),h=R(()=>{const a=m.value.getHours(),g=m.value.getMinutes(),f=m.value.getSeconds();return`${a}:${g<10?"0":""}${g}:${f<10?"0":""}${f}`}),k=R(()=>({width:"3rem",height:"3rem",background:`url(/头像${$.avatarSelected+1}.jpg) no-repeat center center`,backgroundSize:"cover",borderRadius:"50%"})),u=d(null);let w=0,v=0,c=0,_=0,l=0;const I=a=>{p("messageHeight",a)};W(()=>{if(u.value){const a=getComputedStyle(u.value);w=u.value.clientHeight,v=parseInt(a.marginTop),c=parseInt(a.marginBottom),_=parseInt(a.paddingTop),l=parseInt(a.paddingBottom),I(M())}});const M=()=>w+v+c+_+l;return(a,g)=>(y(),C("div",{class:"msg",ref_key:"chatMessage",ref:u},[s("div",re,[s("div",ie,[s("div",{style:K(H(k))},null,4),s("div",de,[E(a.$slots,"username",{},void 0,!0)])]),ue,s("div",me,[s("div",ge,[E(a.$slots,"msg",{},void 0,!0)])])]),s("div",pe,[s("div",he,"-"+T(H(h))+"-",1)])],512))}},_e=L(ve,[["__scopeId","data-v-cf2debcc"]]);const fe=o=>(q("data-v-22192d63"),o=o(),A(),o),Se={class:"room"},ye={class:"intent-area"},ke=fe(()=>s("div",null,"➠",-1)),we=[ke],Ie={__name:"ChatRoom",setup(o){let p=d(0);const{data:$,setOnlineCountData:m}=b("onlineCountData"),h=X(),k=G(),u=P.create({baseURL:"/api",timeout:3e3,withCredentials:!0}),{data:w,setShow:v}=b("isShow");v(k.meta.isShow);const c=d(""),_=d(null),l=d(null),I=()=>{const e=l.value;e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})};function M(){const e=l.value;return parseInt(e.scrollTop)==e.scrollHeight-e.clientHeight-S.value||parseInt(e.scrollTop)-1==e.scrollHeight-e.clientHeight-S.value||parseInt(e.scrollTop)+1==e.scrollHeight-e.clientHeight-S.value}const a=U();let g={name:localStorage.getItem("username"),avatarSelected:localStorage.getItem("avatarSelected")};W(()=>{x(),f()});const f=()=>{i({type:"success",message:a.WelcomeUser,duration:1500})};function x(){let e=localStorage.getItem("username");e?(u.post("/login",g).then(t=>{t.data.statuts=="sucessed"?setTimeout(()=>{h.push("/chatRoom")},500):t.data.statuts=="failedAtDuplicationOfName"&&i({type:"error",message:"你取得用户名和别人重名了",duration:2e3})}).catch(t=>{console.log(t),t.message=="Request failed with status code 500"?i({type:"error",message:"服务器响应失败!!!",duration:3e3}):t.message=="timeout of 3000ms exceeded"&&i({type:"error",message:"服务器响应时间过长,失败!!!",duration:3e3})}),a.username=e):h.push("/Login")}Q(()=>{M()&&(l.value.scrollTop=l.value.scrollHeight)});const O=`ws://chat.kexie.space/api/chat/${localStorage.getItem("username")}`,r=new WebSocket(O),{data:be,setEmitSocket:j}=b("EmitSocket");j(r),r.onopen=()=>{console.log("监听到打开事件---WebSocket链接建立成功!")},r.onmessage=z;function z(e){console.log("监听到消息事件---WebSocket消息接收成功!");const t=JSON.parse(e.data);if(t.data.type=="onlineCountChanged"&&(p.value=t.data.onlineCountNow,m(p.value)),t.data.type=="incomingMsg"){let n={message:t.data.content,avatarSelected:t.data.senderAvatarId,username:t.data.name};a.addMessage(n)}}function J(){console.log("监听到关闭事件---WebSocket链接关闭!")}r.onclose=J,Y(()=>{r.close(),i({type:"error",message:"你已经离开聊天室!",duration:1500})}),Z(()=>{i({type:"error",message:"你已经离开聊天室!",duration:1500}),r.close()});const S=d(0),V=e=>{S.value=e};function B(){if(c.value.trim()==""){i({type:"error",message:"请不要输入空消息!!!",duration:1500});return}let e=c.value.trim(),t=JSON.stringify({type:"msg",msg:e,sender:localStorage.getItem("ID"),avatarSelected:localStorage.getItem("avatarSelected")});r.send(t),c.value=""}return(e,t)=>(y(),C("div",Se,[s("div",{class:"msg-stage",ref_key:"containerRef",ref:l},[(y(!0),C(ee,null,te(H(a).messageList,(n,F)=>(y(),ce(_e,{avatarSelected:n.avatarSelected,key:F,onMessageHeight:V},{msg:N(()=>[D(T(n.message),1)]),username:N(()=>[D(T(n.username),1)]),_:2},1032,["avatarSelected"]))),128)),s("div",{ref_key:"messagesEnd",ref:_},null,512)],512),s("div",ye,[se(s("input",{inputmode:"text",class:"input input-alt",placeholder:"请发送你的消息!",required:"","onUpdate:modelValue":t[0]||(t[0]=n=>c.value=n),rows:2,type:"textarea",onKeyup:t[1]||(t[1]=oe(n=>B(),["enter"]))},null,544),[[ae,c.value]]),s("button",{class:"send-btn",onClick:t[2]||(t[2]=ne(n=>B(),["prevent"]))},we)]),s("div",null,[s("button",{class:"scroll-to-bottom",onClick:I}," ↓ ")])]))}},He=L(Ie,[["__scopeId","data-v-22192d63"]]);export{He as default};
