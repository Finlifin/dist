import{_ as N,u as U,r as i,c as B,o as O,a as y,b as M,d as t,n as K,e as C,f as E,t as H,p as W,g as j,i as b,h as X,j as G,E as R,k as P,l as Q,F as Y,m as Z,w as ee,v as te,q as se,s as oe,x as ae,y as ne,z as D,A as L}from"./index-291206f8.js";const ce=n=>(W("data-v-8ce6bc45"),n=n(),j(),n),le={class:"main"},re={class:"metainfo"},ie={class:"username"},de=ce(()=>t("div",{class:"decoration"},null,-1)),ue={class:"content"},ge={class:"chat-message"},me={class:"time-stamp"},pe={class:"TimeLine"},he={__name:"chatMessage",props:{avatarSelected:Number},emits:["messageHeight"],setup(n,{emit:p}){const $=n;U();const u=i(new Date),h=B(()=>{const o=u.value.getHours(),m=u.value.getMinutes(),k=u.value.getSeconds();return`${o}:${m<10?"0":""}${m}:${k<10?"0":""}${k}`}),I=B(()=>({width:"3rem",height:"3rem",background:`url(/头像${$.avatarSelected+1}.jpg) no-repeat center center`,backgroundSize:"cover",borderRadius:"50%"})),g=i(null);let v=0,c=0,_=0,l=0,S=0;const w=o=>{p("messageHeight",o)};O(()=>{if(g.value){const o=getComputedStyle(g.value);v=g.value.clientHeight,c=parseInt(o.marginTop),_=parseInt(o.marginBottom),l=parseInt(o.paddingTop),S=parseInt(o.paddingBottom),w(d())}});const d=()=>v+c+_+l+S;return(o,m)=>(y(),M("div",{class:"msg",ref_key:"chatMessage",ref:g},[t("div",le,[t("div",re,[t("div",{style:K(C(I))},null,4),t("div",ie,[E(o.$slots,"username",{},void 0,!0)])]),de,t("div",ue,[t("div",ge,[E(o.$slots,"msg",{},void 0,!0)])])]),t("div",me,[t("div",pe,"-"+H(C(h))+"-",1)])],512))}},ve=N(he,[["__scopeId","data-v-8ce6bc45"]]);const _e=n=>(W("data-v-fcede626"),n=n(),j(),n),Se={class:"room"},fe={class:"intent-area"},ye=_e(()=>t("div",null,"➠",-1)),Ie=[ye],we={__name:"ChatRoom",setup(n){let p=i(0);const{data:$,setOnlineCountData:u}=b("onlineCountData"),h=X(),I=G(),{data:g,setShow:v}=b("isShow");v(I.meta.isShow);const c=i(""),_=i(null),l=i(null),S=()=>{const e=l.value;e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})};function w(){const e=l.value;return parseInt(e.scrollTop)==e.scrollHeight-e.clientHeight-f.value||parseInt(e.scrollTop)-1==e.scrollHeight-e.clientHeight-f.value||parseInt(e.scrollTop)+1==e.scrollHeight-e.clientHeight-f.value}const d=U();O(()=>{m(),o()});const o=()=>{R({type:"success",message:d.WelcomeUser,duration:1500})};function m(){let e=localStorage.getItem("username");e?(d.username=e,h.push("/chatRoom")):h.push("/Login")}P(()=>{w()&&(l.value.scrollTop=l.value.scrollHeight)});const T=`ws://chat.kexie.space/api/chat/${localStorage.getItem("username")}`,r=new WebSocket(T),{data:ke,setEmitSocket:q}=b("EmitSocket");q(r),r.onopen=()=>{console.log("监听到打开事件---WebSocket链接建立成功!")},r.onmessage=z;function z(e){console.log("监听到消息事件---WebSocket消息接收成功!");const s=JSON.parse(e.data);if(s.data.type=="onlineCountChanged"&&(p.value=s.data.onlineCountNow,u(p.value)),s.data.type=="incomingMsg"){let a={message:s.data.content,avatarSelected:s.data.senderAvatarId,username:s.data.name};d.addMessage(a)}}function A(){console.log("监听到关闭事件---WebSocket链接关闭!")}r.onclose=A;function V(){let e={type:"SignOut",sender:localStorage.getItem("ID")};ae.create({baseURL:"/api",timeout:3e3,withCredentials:!0}).post("/login",e).then(a=>{console.log(a.data)}).catch(a=>{console.log(a)}),localStorage.removeItem("username"),localStorage.removeItem("avatarSelected"),localStorage.removeItem("ID"),r.close()}window.addEventListener("beforeunload",V),Q(()=>{r.close()});const f=i(0),F=e=>{f.value=e};function x(){if(c.value.trim()==""){R({type:"error",message:"请不要输入空消息!!!",duration:1500});return}let e=c.value.trim(),s=JSON.stringify({type:"msg",msg:e,sender:localStorage.getItem("ID"),avatarSelected:localStorage.getItem("avatarSelected")});r.send(s),c.value=""}return(e,s)=>(y(),M("div",Se,[t("div",{class:"msg-stage",ref_key:"containerRef",ref:l},[(y(!0),M(Y,null,Z(C(d).messageList,(a,J)=>(y(),ne(ve,{avatarSelected:a.avatarSelected,key:J,onMessageHeight:F},{msg:D(()=>[L(H(a.message),1)]),username:D(()=>[L(H(a.username),1)]),_:2},1032,["avatarSelected"]))),128)),t("div",{ref_key:"messagesEnd",ref:_},null,512)],512),t("div",fe,[ee(t("input",{inputmode:"text",class:"input input-alt",placeholder:"请发送你的消息!",required:"","onUpdate:modelValue":s[0]||(s[0]=a=>c.value=a),rows:2,type:"textarea",onKeyup:s[1]||(s[1]=se(a=>x(),["enter"]))},null,544),[[te,c.value]]),t("button",{class:"send-btn",onClick:s[2]||(s[2]=oe(a=>x(),["prevent"]))},Ie)]),t("div",null,[t("button",{class:"scroll-to-bottom",onClick:S}," ↓ ")])]))}},Me=N(we,[["__scopeId","data-v-fcede626"]]);export{Me as default};
