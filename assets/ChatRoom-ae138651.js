import{_ as D,u as U,r as i,c as E,o as W,a as k,b as C,d as t,n as J,e as H,f as R,t as $,p as j,g as z,i as M,h as K,j as X,k as G,E as y,l as P,m as Q,q as Y,F as Z,s as ee,w as te,v as se,x as ae,y as oe,z as ne,A as N,B as L}from"./index-cc71d92b.js";const ce=o=>(j("data-v-cf2debcc"),o=o(),z(),o),le={class:"main"},re={class:"metainfo"},ie={class:"username"},de=ce(()=>t("div",{class:"decoration"},null,-1)),ue={class:"content"},ge={class:"chat-message"},me={class:"time-stamp"},pe={class:"TimeLine"},he={__name:"chatMessage",props:{avatarSelected:Number},emits:["messageHeight"],setup(o,{emit:p}){const T=o;U();const u=i(new Date),h=E(()=>{const a=u.value.getHours(),m=u.value.getMinutes(),I=u.value.getSeconds();return`${a}:${m<10?"0":""}${m}:${I<10?"0":""}${I}`}),b=E(()=>({width:"3rem",height:"3rem",background:`url(/头像${T.avatarSelected+1}.jpg) no-repeat center center`,backgroundSize:"cover",borderRadius:"50%"})),g=i(null);let v=0,c=0,_=0,l=0,f=0;const w=a=>{p("messageHeight",a)};W(()=>{if(g.value){const a=getComputedStyle(g.value);v=g.value.clientHeight,c=parseInt(a.marginTop),_=parseInt(a.marginBottom),l=parseInt(a.paddingTop),f=parseInt(a.paddingBottom),w(d())}});const d=()=>v+c+_+l+f;return(a,m)=>(k(),C("div",{class:"msg",ref_key:"chatMessage",ref:g},[t("div",le,[t("div",re,[t("div",{style:J(H(b))},null,4),t("div",ie,[R(a.$slots,"username",{},void 0,!0)])]),de,t("div",ue,[t("div",ge,[R(a.$slots,"msg",{},void 0,!0)])])]),t("div",me,[t("div",pe,"-"+$(H(h))+"-",1)])],512))}},ve=D(he,[["__scopeId","data-v-cf2debcc"]]);const _e=o=>(j("data-v-bda9f045"),o=o(),z(),o),fe={class:"room"},Se={class:"intent-area"},ye=_e(()=>t("div",null,"➠",-1)),ke=[ye],be={__name:"ChatRoom",setup(o){let p=i(0);const{data:T,setOnlineCountData:u}=M("onlineCountData"),h=K(),b=X();G.create({baseURL:"/api",timeout:3e3,withCredentials:!0});const{data:g,setShow:v}=M("isShow");v(b.meta.isShow);const c=i(""),_=i(null),l=i(null),f=()=>{const e=l.value;e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})};function w(){const e=l.value;return parseInt(e.scrollTop)==e.scrollHeight-e.clientHeight-S.value||parseInt(e.scrollTop)-1==e.scrollHeight-e.clientHeight-S.value||parseInt(e.scrollTop)+1==e.scrollHeight-e.clientHeight-S.value}const d=U();W(()=>{m(),a()});const a=()=>{y({type:"success",message:d.WelcomeUser,duration:1500})};function m(){let e=localStorage.getItem("username");e?(h.push("/chatRoom"),d.username=e):h.push("/Login")}P(()=>{w()&&(l.value.scrollTop=l.value.scrollHeight)});const x=`ws://chat.kexie.space/api/chat/${localStorage.getItem("username")}`,r=new WebSocket(x),{data:we,setEmitSocket:A}=M("EmitSocket");A(r),r.onopen=()=>{console.log("监听到打开事件---WebSocket链接建立成功!")},r.onmessage=O;function O(e){console.log("监听到消息事件---WebSocket消息接收成功!");const s=JSON.parse(e.data);if(s.data.type=="onlineCountChanged"&&(p.value=s.data.onlineCountNow,u(p.value)),s.data.type=="incomingMsg"){let n={message:s.data.content,avatarSelected:s.data.senderAvatarId,username:s.data.name};d.addMessage(n)}}function V(){console.log("监听到关闭事件---WebSocket链接关闭!")}r.onclose=V,Q(()=>{r.close(),y({type:"error",message:"你已经离开聊天室!",duration:1500})}),Y(()=>{y({type:"error",message:"你已经离开聊天室!",duration:1500}),r.close()});const S=i(0),q=e=>{S.value=e};function B(){if(c.value.trim()==""){y({type:"error",message:"请不要输入空消息!!!",duration:1500});return}let e=c.value.trim(),s=JSON.stringify({type:"msg",msg:e,sender:localStorage.getItem("ID"),avatarSelected:localStorage.getItem("avatarSelected")});r.send(s),c.value=""}return(e,s)=>(k(),C("div",fe,[t("div",{class:"msg-stage",ref_key:"containerRef",ref:l},[(k(!0),C(Z,null,ee(H(d).messageList,(n,F)=>(k(),ne(ve,{avatarSelected:n.avatarSelected,key:F,onMessageHeight:q},{msg:N(()=>[L($(n.message),1)]),username:N(()=>[L($(n.username),1)]),_:2},1032,["avatarSelected"]))),128)),t("div",{ref_key:"messagesEnd",ref:_},null,512)],512),t("div",Se,[te(t("input",{inputmode:"text",class:"input input-alt",placeholder:"请发送你的消息!",required:"","onUpdate:modelValue":s[0]||(s[0]=n=>c.value=n),rows:2,type:"textarea",onKeyup:s[1]||(s[1]=ae(n=>B(),["enter"]))},null,544),[[se,c.value]]),t("button",{class:"send-btn",onClick:s[2]||(s[2]=oe(n=>B(),["prevent"]))},ke)]),t("div",null,[t("button",{class:"scroll-to-bottom",onClick:f}," ↓ ")])]))}},Me=D(be,[["__scopeId","data-v-bda9f045"]]);export{Me as default};
